trigger:
- master   # or your default branch

variables:
  buildConfiguration: 'Release'
  # Set those variables in your pipeline library or as pipeline variables, or replace them here:
  acrName: 'naatidevacri0q0'               # e.g., naatidevacri0q0
  acrLoginServer: 'naatidevacri0q0.azurecr.io'  # e.g., naatidevacri0q0.azurecr.io
  containerTag: '$(Build.BuildNumber)'      # Automatically uses Azure build number
  helmChartPathMyNaati: 'NAATI-k8smanifest/mynaati/mynaati'    # Path to MyNaati Helm chart
  helmChartPathNcms: 'NAATI-k8smanifest/ncms/ncms'             # Path to NCMS Helm chart
  helmChartPathInfra: 'NAATI-k8smanifest/naati-infra/naati-infra' # Path to Infrastructure Helm chart
  # FIXED: Use the double ACR server name pattern that works
  imageNcms: 'naatidevacri0q0.azurecr.io/ncmsui'           
  imageMyNaati: 'naatidevacri0q0.azurecr.io/mynaatiui'     
  # Helm release names - YOU can change these!
  releaseNameMyNaati: 'my-mynaati-release'  # Match your current setup
  releaseNameNcms: 'dev-ncms'               # Match your current setup
  targetNamespace: 'default'                # Use default namespace for CI/CD

# variable for uat 
  acrNameUat: 'uatacrimagereg'
  acrLoginServerUat: 'uatacrimagereg.azurecr.io'
  imageNcmsUat: 'uatacrimagereg.azurecr.io/ncmsui'
  imageMyNaatiUat: 'uatacrimagereg.azurecr.io/mynaatiui'
  containerRegistryUat: 'naati-uat-serviceconnection'

  acrNameProd: 'prodacrimagereg'
  acrLoginServerProd: 'prodacrimagereg.azurecr.io'
  imageNcmsProd: 'prodacrimagereg.azurecr.io/ncmsui'
  imageMyNaatiProd: 'prodacrimagereg.azurecr.io/mynaatiui'
  containerRegistryProd: 'naati-prod-serviceconnection'


  #varibale for prod 
  acrNameProd: 'prodacrimagereg'
  acrLoginServerProd: 'prodacrimagereg.azurecr.io'
  imageNcmsProd: 'prodacrimagereg.azurecr.io/ncmsui'
  imageMyNaatiProd: 'prodacrimagereg.azurecr.io/mynaatiui'
  containerRegistryProd: 'naati-prod-serviceconnection' 









pool:
  name: 'Naatipool'    # Your agent pool

steps:
- checkout: self

- powershell: |
    $containerFontsPath = "Naati/Ncms.Ui/ContainerFonts"
    if (Test-Path $containerFontsPath) {
        $files = Get-ChildItem $containerFontsPath
        if (-not $files) {
            Write-Host "ContainerFonts directory is empty, creating placeholder file"
            New-Item -Path "$containerFontsPath/placeholder.txt" -ItemType File -Value "Placeholder file to prevent InstallFonts.ps1 from failing" -Force
        }
    }
  displayName: 'Fix ContainerFonts Directory'

- task: NuGetToolInstaller@1

- task: NuGetCommand@2
  inputs:
    restoreSolution: '**/*.sln'






# Build dependencies first
- task: VSBuild@1
  displayName: 'Build Common Dependencies'
  inputs:
    solution: '**/F1Solutions.Global.Common.csproj'
    configuration: '$(buildConfiguration)'
  continueOnError: true


- task: VSBuild@1
  displayName: 'Build F1Solutions.Global.Azure'
  inputs:
    solution: '**/F1Solutions.Naati.Common.Azure.csproj' 
    configuration: '$(buildConfiguration)'  



- task: VSBuild@1
  displayName: 'Build Dal.NHibernate'
  inputs:
    solution: '**/F1Solutions.Naati.Common.Dal.NHibernate.csproj'
    configuration: '$(buildConfiguration)'
  continueOnError: true

# Search for Contracts project with different possible names
- task: VSBuild@1
  displayName: 'Build F1Solutions.Naati.Common.Contracts'
  inputs:
    solution: '**/F1Solutions.Naati.Common.Contracts.csproj'
    configuration: '$(buildConfiguration)'
  continueOnError: true

- task: VSBuild@1
  displayName: 'Build F1Solutions.Naati.Common.Bl'
  inputs:
    solution: '**/F1Solutions.Naati.Common.Bl.csproj'
    configuration: '$(buildConfiguration)'

- task: VSBuild@1
  displayName: 'Build F1Solutions.Naati.Common.Dal'
  inputs:
    solution: '**/F1Solutions.Naati.Common.Dal.csproj'
    configuration: '$(buildConfiguration)'    

 

- task: VSBuild@1
  displayName: 'Build F1Solutions.Naati.Common.Dal.Nhibernate.Mappings'
  inputs:
    solution: '**/F1Solutions.Naati.Common.Dal.Nhibernate.Mappings.csproj'
    configuration: '$(buildConfiguration)'   



- task: VSBuild@1
  displayName: 'Build F1Solutions.NAATI.Common.Wiise'
  inputs:
    solution: '**/F1Solutions.NAATI.Common.Wiise.csproj'
    configuration: '$(buildConfiguration)'

- task: VSBuild@1
  displayName: 'Build Ncms.Bl'
  inputs:
    solution: '**/Ncms.Bl.csproj'
    configuration: '$(buildConfiguration)'


- task: VSBuild@1
  displayName: 'Build Ncms.Contracts'
  inputs:
    solution: '**/Ncms.Contracts.csproj'
    configuration: '$(buildConfiguration)'   


- task: VSBuild@1
  displayName: 'Build F1Solutions.Naati.Common.Migrations'
  inputs:
    solution: '**/F1Solutions.Naati.Common.Migrations.csproj'
    configuration: '$(buildConfiguration)'      

- task: VSBuild@1
  displayName: 'Build MyNaati.Bl'
  inputs:
    solution: '**/MyNaati.Bl.csproj'
    configuration: '$(buildConfiguration)'      

- task: VSBuild@1
  displayName: 'Build MyNaati.Contracts'
  inputs:
    solution: '**/MyNaati.Contracts.csproj'
    configuration: '$(buildConfiguration)'      





# Build Ncms.Ui with aggressive dependency exclusion
- task: VSBuild@1
  displayName: 'Build Ncms.Ui '
  inputs:
    solution: 'Ncms.Ui/Ncms.Ui.csproj'
    configuration: '$(buildConfiguration)'
    msbuildArgs: '/p:BuildProjectReferences=false /p:SkipInvalidConfigurations=true'

# Publish Ncms.Ui project (Release, all dependencies to /publish)
- task: VSBuild@1
  displayName: 'Publish Ncms.Ui'
  inputs:
    solution: 'Ncms.Ui/Ncms.Ui.csproj'
    configuration: '$(buildConfiguration)'
    msbuildArgs: '/p:DeployOnBuild=true /p:PublishProfile=FolderProfile /p:PublishDir=$(Build.ArtifactStagingDirectory)/Ncms.Ui/publish/'

# Copy all source code (for reference) next to the publish folder if desired
- powershell: |
    Write-Host "Copying Ncms.Ui source for debugging (optional)..."
    $src = "$(Build.SourcesDirectory)\Ncms.Ui"
    $dest = "$(Build.ArtifactStagingDirectory)\Ncms.Ui\src"
    # Create destination directory if it doesn't exist
    New-Item -ItemType Directory -Path $dest -Force | Out-Null
    # Copy all files and folders, overwrite if exists
    Copy-Item -Path "$src\*" -Destination $dest -Recurse -Force
  displayName: 'Copy Source to Publish Artifact (optional)'



# Try building with the temporary solution that excludes Migrations
# - task: VSBuild@1
#   displayName: 'Build with Temporary Solution (No Migrations)'
#   inputs:
#     solution: 'TempBuild.sln'
#     configuration: '$(buildConfiguration)'
#   condition: failed()
#   continueOnError: true

# # Last resort: Force build just the assemblies we need for Docker
# - script: |
#     echo "Force building Ncms.Ui"
#     "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe" "Ncms.Ui\Ncms.Ui.csproj" /p:Configuration=$(buildConfiguration) /p:Platform="Any CPU" /p:BuildProjectReferences=false /p:SkipInvalidConfigurations=true /verbosity:minimal
    
#     echo "Force building MyNaati.Ui"
#     "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe" "MyNaati.Ui\MyNaati.Ui.csproj" /p:Configuration=$(buildConfiguration) /p:Platform="Any CPU" /p:BuildProjectReferences=false /p:SkipInvalidConfigurations=true /verbosity:minimal
#   displayName: 'Last Resort: Force Build UI Projects'
#   condition: failed()
#   continueOnError: true

- task: VSBuild@1
  displayName: 'Build MyNaati.Ui'
  inputs:
    solution: 'MyNaati.Ui/MyNaati.Ui.csproj'
    configuration: '$(buildConfiguration)'
    msbuildArgs: '/p:BuildProjectReferences=false /p:SkipInvalidConfigurations=true'

# - task: VSBuild@1
#   displayName: 'Build mynaati Test Projects'
#   inputs:
#     solution: 'MyNaati.Test/MyNaati.Test.csproj'
#     configuration: '$(buildConfiguration)'
#   continueOnError: true

# - task: VSBuild@1
#   displayName: 'Build Ncms Test Project'
#   inputs:
#     solution: 'Ncms.Test/Ncms.Test.csproj'
#     configuration: '$(buildConfiguration)'
#   continueOnError: true

# - task: VSTest@2
#   displayName: 'Run Unit Tests'
#   inputs:
#     testSelector: 'testAssemblies'
#     testAssemblyVer2: |
#       **\*MyNaati.Test.dll
#       **\*Ncms.Test.dll
#     searchFolder: '$(System.DefaultWorkingDirectory)'
#   continueOnError: true

- script: docker info
  displayName: 'Test Docker Access from Agent'


- task: Docker@2
  displayName: 'Build MyNaatiUi Image'
  inputs:
    containerRegistry: 'naati-serviceconnection'
    repository: '$(imageMyNaati)'  # This will create the double ACR name pattern
    command: 'buildAndPush'
    Dockerfile: 'MyNaati.Ui/Dockerfile'   # Fixed case sensitivity
    buildContext: 'MyNaati.Ui'
    tags: |
      $(containerTag)

- task: Docker@2
  displayName: 'Build NcmsUi Image'
  inputs:
    containerRegistry: 'naati-serviceconnection'
    repository: '$(imageNcms)'  # This will create the double ACR name pattern
    command: 'buildAndPush'
    Dockerfile: 'Ncms.Ui/Dockerfile'   # Fixed case sensitivity
    # buildContext: 'Ncms.Ui'
    buildContext: '$(Build.ArtifactStagingDirectory)/Ncms.Ui'
    tags: |
      $(containerTag)  

# - task: Docker@2
#   displayName: 'Build MyNaatiUi Image (UAT)'
#   condition: eq(variables['Build.SourceBranchName'], 'uat')
#   inputs:
#     containerRegistry: '$(containerRegistryUat)'
#     repository: '$(imageMyNaatiUat)'
#     command: 'buildAndPush'
#     Dockerfile: 'MyNaati.Ui/Dockerfile'
#     buildContext: 'MyNaati.Ui'
#     tags: |
#       $(containerTag)



# - task: Docker@2
#   displayName: 'Build Ncms Image (UAT)'
#   condition: eq(variables['Build.SourceBranchName'], 'uat')
#   inputs:
#     containerRegistry: '$(containerRegistryUat)'
#     repository: '$(imageMyNaatiUat)'
#     command: 'buildAndPush'
#     Dockerfile: 'Ncms.Ui/Dockerfile'
#     buildContext: 'Ncms.Ui'
#     tags: |
#       $(containerTag)   


# - task: Docker@2
#   displayName: 'Build MyNaatiUi Image (Prod)'
#   condition: eq(variables['Build.SourceBranchName'], 'prod')
#   inputs:
#     containerRegistry: '$(containerRegistryProd)'
#     repository: '$(imageMyNaatiProd)'
#     command: 'buildAndPush'
#     Dockerfile: 'MyNaati.Ui/Dockerfile'
#     buildContext: 'MyNaati.Ui'
#     tags: |
#       $(containerTag)


# - task: Docker@2
#   displayName: 'Build Ncms Image (Prod)'
#   condition: eq(variables['Build.SourceBranchName'], 'prod')
#   inputs:
#     containerRegistry: '$(containerRegistryProd)'
#     repository: '$(imageMyNaatiProd)'
#     command: 'buildAndPush'
#     Dockerfile: 'Ncms.Ui/Dockerfile'
#     buildContext: 'Ncms.Ui'
#     tags: | 
#       $(containerTag)              





- task: HelmInstaller@1
  displayName: 'Install Helm'
  inputs:
    helmVersionToInstall: 'latest'

# Package MyNaati Helm Chart
- script: |
    helm package $(helmChartPathMyNaati) --version $(containerTag) --destination $(Build.ArtifactStagingDirectory)
  displayName: 'Package MyNaati Helm Chart'

# Package NCMS Helm Chart
- script: |
    helm package $(helmChartPathNcms) --version $(containerTag) --destination $(Build.ArtifactStagingDirectory)
  displayName: 'Package NCMS Helm Chart'

# Package Infrastructure Helm Chart (if needed)
- script: |
    helm package $(helmChartPathInfra) --version $(containerTag) --destination $(Build.ArtifactStagingDirectory)
  displayName: 'Package Infrastructure Helm Chart'



# Deploy MyNaati
- task: AzureCLI@2
  displayName: 'Helm Deploy MyNaati'
  inputs:
    azureSubscription: 'f7fdab19-cae1-4b90-8af8-45052e6b72ca'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      Write-Host "=== Starting MyNaati Deployment ==="
      
      # Get AKS credentials
      Write-Host "Getting AKS credentials..."
      az aks get-credentials --resource-group naati-dev-rg --name naati-dev-aks --overwrite-existing
      
      # Verify kubectl connection
      Write-Host "Testing kubectl connection..."
      kubectl cluster-info
      
      # Check if chart exists
      $chartPath = "$(helmChartPathMyNaati)"
      Write-Host "Chart path: $chartPath"
      if (-not (Test-Path "$chartPath/Chart.yaml")) {
        Write-Error "Chart.yaml not found at $chartPath"
        exit 1
      }
      
      # Validate Helm template first
      Write-Host "Validating Helm template..."
      helm template test-mynaati $chartPath --set image.repository=$(acrLoginServer)/$(imageMyNaati) --set image.tag=$(containerTag) --dry-run
      
      # Deploy MyNaati
      Write-Host "Deploying MyNaati..."
      helm upgrade $(releaseNameMyNaati) $chartPath --install --namespace $(targetNamespace) --create-namespace --version $(containerTag) --set image.repository=$(acrLoginServer)/$(imageMyNaati) --set image.tag=$(containerTag) --wait --timeout=20m --debug
      
      # Check deployment status
      Write-Host "Checking deployment status..."
      # kubectl get pods -n $(targetNamespace) -l app.kubernetes.io/instance=$(releaseNameMyNaati)
      # kubectl describe pods -n $(targetNamespace) -l app.kubernetes.io/instance=$(releaseNameMyNaati)
      
      Write-Host "=== MyNaati Deployment Complete ==="
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))

# Deploy NCMS
- task: AzureCLI@2
  displayName: 'Helm Deploy NCMS'
  inputs:
    azureSubscription: 'f7fdab19-cae1-4b90-8af8-45052e6b72ca'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      Write-Host "=== Starting NCMS Deployment ==="
      
      # Get AKS credentials
      Write-Host "Getting AKS credentials..."
      az aks get-credentials --resource-group naati-dev-rg --name naati-dev-aks --overwrite-existing
      
      # Verify kubectl connection
      Write-Host "Testing kubectl connection..."
      kubectl cluster-info
      
      # Check if chart exists
      $chartPath = "$(helmChartPathNcms)"
      Write-Host "Chart path: $chartPath"
      if (-not (Test-Path "$chartPath/Chart.yaml")) {
        Write-Error "Chart.yaml not found at $chartPath"
        exit 1
      }
      
      # Validate Helm template first
      Write-Host "Validating Helm template..."
      helm template test-ncms $chartPath --set image.repository=$(acrLoginServer)/$(imageNcms) --set image.tag=$(containerTag) --dry-run
      
      # Deploy NCMS
      Write-Host "Deploying NCMS..."
      helm upgrade $(releaseNameNcms) $chartPath --install --namespace $(targetNamespace) --create-namespace --version $(containerTag) --set image.repository=$(acrLoginServer)/$(imageNcms) --set image.tag=$(containerTag) --wait --timeout=20m --debug
      
      # Check deployment status
      Write-Host "Checking deployment status..."

      # kubectl get pods -n $(targetNamespace) -l app.kubernetes.io/instance=$(releaseNameNcms)
      # kubectl describe pods -n $(targetNamespace) -l app.kubernetes.io/instance=$(releaseNameNcms)
      
      Write-Host "=== NCMS Deployment Complete ==="
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))


 
# # ==== UAT DEPLOYMENT STAGE ====
# - stage: Deploy_UAT
#   displayName: 'Deploy to UAT'
#   dependsOn: Build
#   condition: succeeded()
#   variables:
#     azureSubscription: 'f7fdab19-cae1-4b90-8af8-45052e6b72ca'
#     aks_resource_group: 'RG_UAT'
#     aks_cluster: 'aksclusteruat'
#     releaseNameMyNaati: 'uat-mynaati'
#     releaseNameNcms: 'uat-ncms'
#     releaseNameInfra: 'uat-naati-infra'
#     targetNamespace: 'uat'
#   jobs:
#   - deployment: DeployUAT
#     environment: 'uat'
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: 'helm-charts'

#          

#           - task: AzureCLI@2
#             displayName: 'Deploy MyNaati to UAT'
#             inputs:
#               azureSubscription: '$(azureSubscription)'
#               scriptType: 'ps'
#               scriptLocation: 'inlineScript'
#               inlineScript: |
#                 Write-Host "=== Deploying MyNaati to UAT ==="
                
#                 # Get AKS credentials
#                 az aks get-credentials --resource-group $(aks_resource_group) --name $(aks_cluster) --overwrite-existing
                
#                 # Deploy MyNaati using UAT Helm chart
#                 helm upgrade $(releaseNameMyNaati) mynaati --install --namespace $(targetNamespace) \
#                   --version $(containerTag) \
#                   --set image.repository=$(acrLoginServerUat)/mynaatiui \
#                   --set image.tag=$(containerTag) \
#                   --wait --timeout=20m --debug

#           - task: AzureCLI@2
#             displayName: 'Deploy NCMS to UAT'
#             inputs:
#               azureSubscription: '$(azureSubscription)'
#               scriptType: 'ps'
#               scriptLocation: 'inlineScript'
#               inlineScript: |
#                 Write-Host "=== Deploying NCMS to UAT ==="
                
#                 # Get AKS credentials
#                 az aks get-credentials --resource-group $(aks_resource_group) --name $(aks_cluster) --overwrite-existing
                
#                 # Deploy NCMS using UAT Helm chart
#                 helm upgrade $(releaseNameNcms) ncms --install --namespace $(targetNamespace) \
#                   --version $(containerTag) \
#                   --set image.repository=$(acrLoginServerUat)/ncmsui \
#                   --set image.tag=$(containerTag) \
#                   --wait --timeout=20m --debug

# # ==== PROD DEPLOYMENT STAGE ====
# - stage: Deploy_PROD
#   displayName: 'Deploy to Production'
#   dependsOn: Deploy_UAT
#   condition: succeeded()
#   variables:
#     azureSubscription: 'f7fdab19-cae1-4b90-8af8-45052e6b72ca'
#     aks_resource_group: 'RG_PROD'
#     aks_cluster: 'akscluster4'

#     releaseNameNaati: 'prod'
#     releaseNameInfra: 'prod-naati-infra'
#     releaseNameClusterInfra: 'prod-cluster-infra'
#     targetNamespace: 'prod'
#   jobs:
#   - deployment: DeployPROD
#     environment: 'production'
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: 'helm-charts'

#           
#           - task: AzureCLI@2
#             displayName: 'Deploy NAATI Application to PROD'
#             inputs:
#               azureSubscription: '$(azureSubscription)'
#               scriptType: 'ps'
#               scriptLocation: 'inlineScript'
#               inlineScript: |
#                 Write-Host "=== Deploying NAATI Application to PROD ==="
                
#                 # Get AKS credentials
#                 az aks get-credentials --resource-group $(aks_resource_group) --name $(aks_cluster) --overwrite-existing
                
#                 # Deploy NAATI using PROD Helm chart with values file
#                 helm upgrade $(releaseNameNaati) naati --install --namespace $(targetNamespace) \
#                   --version $(containerTag) \
#                   -f "$(helmChartPathProd)/naati/_values.prod.yaml" \
#                   --set ncms.image.repository=$(acrLoginServerprod)/ncmsui \
#                   --set ncms.image.tag=$(containerTag) \
#                   --set mynaati.image.repository=$(acrLoginServerprod)/mynaatiui \
#                   --set mynaati.image.tag=$(containerTag) \
#                   --wait --timeout=20m --debug

#           - task: AzureCLI@2
#             displayName: 'Verify PROD Deployment'
#             inputs:
#               azureSubscription: '$(azureSubscription)'
#               scriptType: 'ps'
#               scriptLocation: 'inlineScript'
#               inlineScript: |
#                 Write-Host "=== Verifying PROD Deployment ==="
                
#                 # Get AKS credentials
#                 az aks get-credentials --resource-group $(aks_resource_group) --name $(aks_cluster) --overwrite-existing
                
#                 # Check deployment status
#                 kubectl get pods -n $(targetNamespace)
#                 kubectl get services -n $(targetNamespace)
                
#                 # Check Helm releases
#                 helm list -n $(targetNamespace)
                
#                 Write-Host "=== PROD Deployment Complete ===" 