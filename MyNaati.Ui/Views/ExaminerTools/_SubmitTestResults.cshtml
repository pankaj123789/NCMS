@using MyNaati.Ui.ViewModels.ExaminerTools
@model MyNaati.Ui.ViewModels.ExaminerTools.SubmitTestModel
@{
    ViewBag.Title = "Manage Test Results";
    Layout = "~/Views/Shared/MasterPages/_Layout.cshtml";
    ViewBag.BreadCrumb = new List<Tuple<string, string>>
{
new Tuple<string, string>("Examiner Tools", Url.Action("Index")),
new Tuple<string, string>("Manage Test Results", null)
};

    var testsSelection = Model
        .TestList
        .Select(t =>
            new SelectListItem
            {
                Text = t.TestSittingId.ToString(),
                Value = t.TestResultID.ToString()
            })
        .Union(new[] {
    new SelectListItem {
        Text = "Choose...",
        Value = ""
    }
        })
        .OrderBy(s => s.Value);

    var test = (from t in Model.TestList
                where t.TestResultID == Model.TestResultID
                select t).FirstOrDefault();


    var alertMessage = TempData["AlertMessage"];

    var documentTypes = Model.DocumentTypes.Select(dt => new SelectListItem { Value = dt.Id.ToString(), Text = dt.DisplayName });
    documentTypes.First().Selected = true;

}
@section Head
{
    @Styles.Render("~/Bundles/Styles/FileUpload")
}
@section Scripts {
    @Scripts.Render("~/Bundles/Scripts/FileUpload")
<script type="text/javascript">
        var submitTestResults = function () {
            function reloadDataTable() {
                $('#attachmentsTable').DataTable().ajax.reload();
            }

            var confirmationModalCallback;
            function confirmModal(action, message, callback) {
                var $modal = $('#confirmationModal');
                var $modalHeader = $modal.find('.modal-header');
                var $confirmButton = $('#confirmModal');

                $modal.find('.modal-title').html(action);
                $modal.find('.modal-body p').html(message);
                confirmationModalCallback = callback;

                if (action === 'Delete') {
                    $modalHeader.removeClass('bg-primary');
                    $modalHeader.addClass('bg-danger');
                    $confirmButton.removeClass('btn-primary');
                    $confirmButton.addClass('btn-danger');
                } else {
                    $modalHeader.removeClass('bg-danger');
                    $modalHeader.addClass('bg-primary');
                    $confirmButton.removeClass('btn-danger');
                    $confirmButton.addClass('btn-primary');
                }

                $modal.modal('show');
            }

            return {
                validate: true,
                reloadDataTable: reloadDataTable,
                downloadAttachment: function (documentId) {
                    var $downloadForm = $('#downloadForm');
                    var action = '@Url.Action("DownloadAttachment", "ExaminerTools", new { id = "DocumentId" })'.replace('DocumentId', documentId);

                    $downloadForm.attr('action', action);
                    $downloadForm.submit();
                },
                deleteAttachment: function (documentId) {
                    confirmModal('Delete', 'Are you sure you want to delete the attachment?', function () {
                        var url = '@Url.Action("DeleteAttachment", "ExaminerTools", new { id = "DocumentId" })'.replace('DocumentId', documentId);

                        $.ajax({
                            type: 'POST',
                            cache: false,
                            url: url,
                            success: reloadDataTable,
                            error: function (error) {
                                toastr.error("User is not authorised to access this item.");
                            }
                        });
                    });
                },
                calculateCombinedMarks: function () {
                    var combinedMark = 0;
                    var allPopulated = true;

                    $('[data-component-container="true"] input.form-control').each(function () {
                        if ($(this).val() === '') {
                            allPopulated = false;
                        } else {
                            combinedMark += parseFloat($(this).val());
                        }
                    });


                    $('#overall').val(Math.round(combinedMark * 10) / 10);
                },
                confirmModal: confirmModal,
                confirmationModalCallback: function () {
                    confirmationModalCallback();
                    $('#confirmationModal').modal('hide');
                }
            };
        }();

        $(document).ready(function () {
            $("[data-toggle=tooltip]").tooltip();

            @if (Model.TestResultID.HasValue)
            {
                @:submitTestResults.calculateCombinedMarks();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

            var $components = $('[data-component-container="true"] input.form-control');
            $components.change(function () {
                var $this = $(this);
                var value = $this.val();
                var parsedValue = isNaN(value) ? 0 : parseFloat(value);

                if (parsedValue < 0) {
                    $this.val(0);
                } else {
                    $this.val(Math.round(parsedValue * 10) / 10);
                }

                submitTestResults.calculateCombinedMarks();
            });

            var $comments = $('#comments textarea');
            autosize($comments);

            var $attachmentsTable = $('#attachmentsTable');

            $attachmentsTable.DataTable({
                ajax: {
                    url: '@Url.Action("Attachments", new {id = Model.TestResultID})',
                    type: 'POST'
                },
                autoWidth: false,
                columns: [
                    { data: 'Title' },
                    { data: 'Type' },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var documentId = row.TestAttendanceDocumentId;
                            return '' +
                                '<div class="btn-group pull-right">' +
                                '<button class="btn btn-success" type="button" data-document-action="download" data-document-id="' + documentId + '">Download</button>' +
                                '<button class="btn btn-danger" type="button" data-document-action="delete" data-document-id="' + documentId + '">Delete</button>' +
                                '</div>';
                        }
                    }
                ],
                dom: "<'row v-offset-xs-1'<'col-sm-12'<'table-responsive't>>>",
                info: false,
                language: {
                    processing: $('#loadingOverlayTemplate').html(),
                    zeroRecords: 'No Attachments'
                },
                ordering: false,
                paging: false,
                processing: true,
                searching: false,
                serverSide: true
            });

            $attachmentsTable.on('draw.dt', function () {
                $(this).find('tbody tr').on('click', '.btn', function () {
                    var $this = $(this);
                    var documentAction = $this.data('documentAction');
                    var documentId = $this.data('documentId');

                    submitTestResults[documentAction + 'Attachment'](documentId);
                });
            });

            var selectedType = $("select#selectedType")[0];

            Dropzone.options.fileAttachments = {
                url: function () {
                    return '@Url.Action("SubmitTestResultAttachment")' + '/' + selectedType.children[selectedType.selectedIndex].value;
                },
                thumbnailWidth: 80,
                thumbnailHeight: 80,
                maxFilesize: 2048,
                previewTemplate: $('#dropzonePreviewTemplate').html(),
                previewsContainer: '#previews',
                params: {
                    id: '@Model.TestResultID'
                },
                init: function () {
                    this.on('queuecomplete', function () {
                        $('#previews .dz-complete').remove();
                        submitTestResults.reloadDataTable();
                    });
                }
            };

            $('a[data-toggle="tab"]').on('shown.bs.tab', function () {
                autosize.update($comments);
            });

            $('#TestResultID').change(function () {
                if ($(this).val() !== "") {
                    document.location.href = '@Url.Action("SubmitTestResults", "ExaminerTools", new { id = "TestResultID" })'
                        .replace('TestResultID', $(this).val());
                }
            });

            $('#confirmModal').click(function () {
                submitTestResults.confirmationModalCallback();
            });

            var tablist = $('.nav-tabs');
            tablist.each(function(){
                $(this).find('li').each(function (index) {
                    $(this).click(function (e) {
                        $('#ReturnElement').val($(this).find("a").attr("aria-controls"));
                    });
                });
            });

            var $action = $('#Action');

            $('#saveButton').click(function () {
                submitTestResults.validate = false;
                $action.val('Save');
            });

            $('#submitTestResults').submit(function (e) {
                if (!submitTestResults.validate) {
                    return true;
                }

                var msg = 'Are you sure you want to submit the marks?';

                if ($attachmentsTable.DataTable().rows().data().length === 0) {
                    msg += '<br/><br/>Please note you will need to attach supporting documents if it is a Translator test.';
                }

                submitTestResults.confirmModal('Submit', msg, function () {
                    submitTestResults.validate = false;
                    $action.val('Submit');
                    $('#submitTestResults').submit();
                });

                e.preventDefault();
                return false;
            });

            toastr.options = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-top-right",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "2000",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };

            if ($('#IsSave').val() === 'Saved successfully.') {
                toastr.success('Results were successfully saved');
            }
        });
</script>
    @RenderSection("Scripts", false)
}
@helper Detail(string label, string value, int size)
{
    <div class="col-xs-@size">
        <div class="form-group">
            <label>@label</label>
            <p class="form-control-static">@Html.Raw(value)</p>
        </div>
    </div>
}
@helper AttendanceIDField(TestModel test)
{
    var field = String.Format("<span>{0}</span>", test.TestSittingId);
    if (test.Supplementary)
    {
        field += "&nbsp;&nbsp;<span data-toggle='tooltip' class='cursor-pointer label badge bg-black-opacity' title='Supplementary Test'>S</span>";
    }
    if (!test.HasDefaultSpecification)
    {
        field += "&nbsp;&nbsp;<span data-toggle='tooltip' class='cursor-pointer label badge bg-danger' title='This is a test with an older test specification. Please consult NAATI if you are not sure how this test should be marked.'> ! </span>";
    }
    @Detail("Attendance ID", field, 2)
}
<div class="col-lg-12">
    @using (Html.BeginForm("SubmitTestResults", "ExaminerTools", FormMethod.Post, new { id = "submitTestResults", enctype = "multipart/form-data" }))
    {
        <div class="row">
            <div class="col-lg-12">
                <h3 class="text-primary">@ViewBag.Title</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2">
                <div class="form-horizontal">
                    <div class="form-group">
                        @Html.Label("TestResultID", "Test", new { @class = "control-label col-xs-4" })
                        <div class="col-xs-8">
                            @Html.DropDownListFor(m => m.TestResultID, testsSelection, new { @class = "form-control" })
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                @Html.ValidationSummary()
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                @if (test == null)
                {
                    <p>Please select a test to submit results.</p>
                }
                else
                {
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="panel panel-default wrapper">
                                <div class="row">
                                    @AttendanceIDField(test)
                                    @Detail("Skill", test.SkillDisplayName, 2)
                                    @Detail("Status", test.Status, 2)
                                    @Detail("Credential Type", test.CredentialTypeExternalName, 4)
                                    @Detail("Test Date", test.TestDate.ToString("d/MM/yyyy"), 1)
                                    @Detail("Due Date", test.DueDate.HasValue ? test.DueDate.Value.ToString("d/MM/yyyy") : string.Empty, 1)

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <ul class="nav nav-tabs" role="tablist">
                                @Html.HiddenFor(m => m.ReturnElement, Model.ReturnElement)
                                @RenderSection("TabHeader")
                                <li role="presentation" class="@(Model.ReturnElement == "attachments" ? "active" : "")"><a href="#attachments" aria-controls="attachments" role="tab" data-toggle="tab">Attachments</a></li>
                                <li role="presentation" class="@(Model.ReturnElement == "feedback" ? "active" : "")"><a href="#feedback" aria-controls="feedback" role="tab" data-toggle="tab">Feedback</a></li>
                            </ul>
                            <div class="tab-content">
                                @RenderSection("TabContent")
                                <div id="attachments" class="tab-pane @(Model.ReturnElement == "attachments" ? "active" : "")" role="tabpanel">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="col-sm-5 form-group form-horizontal">
                                                <label class="control-label col-xs-4">Document Type</label>
                                                <div class="col-xs-8">
                                                    @Html.DropDownList("selectedType", documentTypes, new { @class = "form-control" })
                                                </div>
                                            </div>
                                            <br />
                                            <br />
                                            <div id="fileAttachments" class="dropzone">
                                                <div class="dz-message">
                                                    <div class="row">
                                                        <div class="col-lg-12">
                                                            <i class="fa fa-upload fa-5x text-primary" aria-hidden="true"></i>
                                                        </div>
                                                    </div>
                                                    <div class="row v-offset-xs-3">
                                                        <div class="col-lg-12">
                                                            <p>
                                                                <strong>Choose a file</strong> or drag it here.
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="previews" class="table table-striped files">

                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <table id="attachmentsTable" class="table table-bordered">
                                                <thead class="bg-primary">
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Type</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div id="feedback" class="tab-pane @(Model.ReturnElement == "feedback" ? "active" : "")" role="tabpanel">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <span class="control-label">Feedback</span>
                                            <span> (Must be between 10 characters and 2000 characters)</span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="form-group">
                                                <textarea placeholder = "This is for comments pertaining to the test delivery e.g. role player or material issues and not for comments on candidate performance" name="Feedback" class="form-control" rows="5" style="resize: none;">@Model.Feedback</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <input type="hidden" id="IsSave" value="@alertMessage"/>
                <button id="saveButton" class="btn btn-danger" type="submit">Save</button>
                <button class="btn btn-danger" type="submit">Submit</button>
            </div>
        </div>
        @Html.HiddenFor(m => m.Action)
        @Html.HiddenFor(m => m.TestType)
    }
</div>
<div id="confirmationModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <p></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirmModal" type="button" class="btn btn-primary">Confirm</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<form id="downloadForm" method="post"></form>
<script id="dropzonePreviewTemplate" type="text/html">
    <div class="row v-offset-xs-3">
        <div class="col-sm-2">
            <span class="preview"><img data-dz-thumbnail /></span>
        </div>
        <div class="col-sm-4">
            <p class="name" data-dz-name></p>
            <strong class="error text-danger" data-dz-errormessage></strong>
        </div>
        <div class="col-sm-6">
            <div class="row">
                <div class="col-sm-4">
                    <p class="size" data-dz-size></p>
                </div>
                <div class="col-sm-7">
                    <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <div class="progress-bar progress-bar-success" style="width:0;" data-dz-uploadprogress></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
